#!/usr/bin/env python3
#
# coding=utf-8
#
import os
import sys
import subprocess

import openai
import whisper

cmd_en = True

def die( msg ):
    print( f'ERROR: {msg}' )
    sys.exit( 1 )

def cmd( c, echo=True, echo_stdout=False, can_die=True ):  
    if echo: print( c )
    if cmd_en:
        info = subprocess.run( c, shell=True, text=True, stdout=subprocess.PIPE, stderr=subprocess.STDOUT )
        if echo_stdout: print( info.stdout )
        if can_die and info.returncode != 0: die( f'command failed: {c}' )
        return info.stdout
    else:
        return ''

openai.api_key   = os.getenv( 'OPENAI_API_KEY' )
model            = 'gpt-4-turbo'
context          = ''
is_multi_line    = False
recording_dead_time = 3.0
english_voice    = 'Samantha'
italian_voice    = 'Alice'
voice_rate       = 190
is_italian_convo = False

i = 1
while i < len(sys.argv):
    arg = sys.argv[i]
    i += 1
    if   arg == '-m':
        model = sys.argv[i]
        i += 1
    elif arg == '-c':
        context = sys.argv[i]
        i += 1
    elif arg == '-recording_dead_time':
        recording_dead_time = float( sys.argv[i] )
        i += 1
    elif arg == '-english_voice':
        english_voice = sys.argv[i]
        i += 1
    elif arg == '-italian_voice':
        italian_voice = sys.argv[i]
        i += 1
    elif arg == '-is_italian_convo':
        is_italian_convo = int( sys.argv[i] )
        i += 1
    elif arg == '-r' or arg == '-voice_rate':
        voice_rate = int( sys.argv[i] )
        i += 1
    else:
        die( f'unknown option: {arg}' )

wmodel = whisper.load_model( "base" )

def prompt_read( prefix, is_multi_line ):
    prompt = input( prefix )
    if not is_multi_line: return prompt
    while True:
         extra = input( '' )
         if extra == '': return prompt
         prompt += '\n' + extra

def record_audio( always_submit ):
    while True:
        #if is_italian_convo: input( f'Hit return when ready to record: ' )
        print( f'Recording will stop after {recording_dead_time} seconds of silence' )
        audio_file_path = 'gpt_audio.wav'
        cmd( f'rm -f {audio_file_path}', False )
        cmd( f'rec {audio_file_path} silence 1 0.1 3% 1 {recording_dead_time} 3%', False, False )
        print( f'Transcribing text...\n' )
        result = wmodel.transcribe( audio_file_path, fp16=False )
        transcribed_text = result['text'] 
        print( f'{transcribed_text}\n' )
        if always_submit: return transcribed_text
        while True:
            resp = input( f'Type r=re-record c=correct s=submit a=abandon: ' )
            if resp == 'r' or resp == 'c' or resp == 's' or resp == 'a': break
        if resp != 'r': break
    if resp == 'c': transcribed_text = f'correggi questo testo: {transcribed_text}'
    if resp == 'a': transcribed_text = ''
    return transcribed_text

def speak_text( text, voice ):
    with open( 'gpt_text.txt', 'w' ) as file:
        file.write( text )
    cmd( f'say -f gpt_text.txt -v {voice} -r {voice_rate}', False, False )

messages=[ {'role': 'system', 'content': 'Ask me anything.'} ]
if context == 'translations':
    context = 'Here are some phrases in either English or Italian. For each phrase, please output a pair of lines. The first line always shows the English translation. The second line always shows the Italian translation. Then add a blank line after those two lines. That should be the order regardless of whether the original phrase is in English or Italian. If you\'d like to list a couple English/Italian translations, that\'s fine, just separate them with semicolons; Finally, please do not capitalize words unless they are always capitalized. So to summarize, for each phrase your output should be:\n<English translations separate by semicolons>\n<Italian translations separated by semicolons\n\n' 
    is_multi_line = True

elif context != '':
     die( f'unknown context: {context}' )

while True:
    if is_italian_convo:
        prompt = record_audio( True )
        if prompt == '': continue
    else:
        prompt = prompt_read( '', is_multi_line )
        if context != '':
            prompt = context + '\n' + prompt
            context = ''
        elif prompt == '!v' or prompt == '!V':
            prompt = record_audio( prompt == '!V' )
            if prompt == '': continue # abandoned
        elif prompt == '!e' or prompt == '!i':
            voice = english_voice if prompt == '!e' else italian_voice
            speak_text( messages[-1]['content'], voice )
            continue

    messages.append( {'role': 'user', 'content': prompt} )
    print( '-----------------------------------\n' )

    response = openai.ChatCompletion.create(
        model=model,
        messages=messages,
        max_tokens=1024,
        n=1,
        temperature=0.5,
        top_p=1,
        frequency_penalty=0.0,
        presence_penalty=0.6,
    )
    resp = response['choices'][0]['message']['content']
    messages.append( {'role': 'assistant', 'content': resp} )
    print( f'{resp}' )
    print( '-----------------------------------\n' )
    resp_text = messages[-1]['content']
    if is_italian_convo and len(resp_text) < 500: speak_text( resp_text, italian_voice )
